---
name: 'step-05-generate'
description: 'Generate final Golden Map JSON, QA Report, and Performance Metrics'

# Path Definitions
workflow_path: '{project-root}/.bmad-user-memory/modules/interactive-pdf-mapper/workflows/discovery-workflow'

# File References
thisStepFile: '{workflow_path}/steps/step-05-generate.md'
nextStepFile: '{workflow_path}/steps/step-06-cache.md'
workflowFile: '{workflow_path}/workflow.md'
outputFile: '{output_folder}/golden-map-{project_name}.json'
qaReportFile: '{output_folder}/qa-report-{project_name}.md'
metricsFile: '{output_folder}/metrics-{project_name}.json'

# Template References
goldenMapTemplate: '{workflow_path}/templates/golden-map-template.json'
---

# Step 5: Output Generation

## STEP GOAL:

To generate the final Golden Map JSON with complete field data, create a QA Report documenting validation results, and produce Performance Metrics for system optimization.

## MANDATORY EXECUTION RULES (READ FIRST):

### Universal Rules:

- NEVER generate content without user input
- CRITICAL: Read the complete step file before taking any action
- CRITICAL: When loading next step with 'C', ensure entire file is read
- YOU ARE A FACILITATOR, not a content generator

### Role Reinforcement:

- You are an output generation specialist
- You bring expertise in data formatting and report generation
- Ensure all outputs are production-ready
- Report progress verbosely

### Step-Specific Rules:

- Focus ONLY on output generation
- FORBIDDEN to modify field data
- Generate all three output files
- Validate output schema compliance

## EXECUTION PROTOCOLS:

- Finalize Golden Map JSON structure
- Generate comprehensive QA Report
- Create Performance Metrics JSON
- Validate all outputs against schemas

## CONTEXT BOUNDARIES:

- Complete organized field data from step 4
- Validation results from step 3
- Detection metrics from step 2
- All metadata accumulated through workflow

## GENERATION SEQUENCE:

### 1. Finalize Golden Map JSON

Ensure output file has complete structure:

```json
{
  "documentId": "[uuid]",
  "documentName": "[filename]",
  "pages": [
    {
      "pageNumber": 1,
      "dimensions": { "width": [w], "height": [h] }
    }
  ],
  "sections": [
    {
      "sectionId": "[id]",
      "sectionName": "[name]",
      "subsections": [...],
      "fields": [...]
    }
  ],
  "allFields": [
    {
      "fieldId": "[id]",
      "fieldType": "[type]",
      "coordinates": {...},
      "hierarchy": {...},
      "pageNumber": [n],
      "sectionId": "[id]",
      "renderOrder": [n],
      "cssCoordinates": {...},
      "uiHints": {...},
      "confidenceScore": [n],
      "sectionClassification": "[class]",
      "validationStatus": "[status]"
    }
  ],
  "coordinateSystem": "pdf-to-css",
  "metadata": {
    "createdDate": "[date]",
    "lastValidated": "[date]",
    "accuracyScore": [n],
    "evolutionVersion": 1,
    "totalFields": [n],
    "totalSections": [n],
    "stepsCompleted": [1, 2, 3, 4, 5]
  }
}
```

### 2. Generate QA Report

Create QA Report at `{qaReportFile}`:

```markdown
# QA Report: [Document Name]

**Generated**: [timestamp]
**Workflow Version**: 1.0.0

## Executive Summary

- **Overall Accuracy**: [X]%
- **Fields Validated**: [N]/[Total]
- **Quality Status**: [PASS/WARN/FAIL]

## Detection Results

| Metric | Value | Target | Status |
|--------|-------|--------|--------|
| Field Detection Accuracy | [X]% | 99.9% | [PASS/FAIL] |
| Coordinate Precision | ±[X]px | ±0.5px | [PASS/FAIL] |
| Processing Time | [X]s | <5s/page | [PASS/FAIL] |

## Field Type Breakdown

| Type | Count | Validated | Accuracy |
|------|-------|-----------|----------|
| Text Input | [N] | [N] | [X]% |
| Signature | [N] | [N] | [X]% |
| Date | [N] | [N] | [X]% |
| Checkbox | [N] | [N] | [X]% |

## Section Coverage

| Section | Fields | Validated | Status |
|---------|--------|-----------|--------|
| [Section Name] | [N] | [N] | [PASS/FAIL] |

## Validation Issues

### Skipped Fields (Retry Pool)

| Field ID | Page | Reason | Retry Count |
|----------|------|--------|-------------|
| [id] | [N] | [reason] | 7 |

## Recommendations

1. [Recommendation based on results]
2. [Recommendation based on results]

---
*Generated by PDF Discovery Workflow*
```

### 3. Generate Performance Metrics

Create Metrics JSON at `{metricsFile}`:

```json
{
  "workflowId": "[uuid]",
  "documentId": "[uuid]",
  "timestamp": "[iso-date]",
  "performance": {
    "totalProcessingTime": "[ms]",
    "averageTimePerPage": "[ms]",
    "averageTimePerField": "[ms]",
    "detectionTime": "[ms]",
    "validationTime": "[ms]",
    "organizationTime": "[ms]"
  },
  "accuracy": {
    "overallAccuracy": [percentage],
    "detectionConfidence": [percentage],
    "validationPassRate": [percentage],
    "coordinatePrecision": [pixels]
  },
  "volume": {
    "totalPages": [n],
    "totalFields": [n],
    "totalSections": [n],
    "fieldsPerPage": [average],
    "retryPoolSize": [n]
  },
  "cacheRecommendations": {
    "shouldCache": true,
    "estimatedCacheSize": "[bytes]",
    "expectedHitRate": "[percentage]"
  }
}
```

### 4. Validate Outputs

Verify all outputs:
- Golden Map JSON is valid JSON
- All required fields present
- QA Report is valid Markdown
- Metrics JSON is valid JSON

### 5. Progress Report (Verbose)

"**Output Generation Complete**

**Files Generated:**
1. Golden Map JSON: `{outputFile}`
   - Size: [X] KB
   - Fields: [N]
   - Sections: [N]

2. QA Report: `{qaReportFile}`
   - Overall Accuracy: [X]%
   - Quality Status: [PASS/WARN/FAIL]

3. Performance Metrics: `{metricsFile}`
   - Total Processing Time: [X]s
   - Average per Page: [X]ms

**Validation:**
- All outputs validated successfully
- Schema compliance: PASS

Ready to proceed to caching."

### 6. Update Output File Metadata

Update metadata:
- `stepsCompleted`: [1, 2, 3, 4, 5]
- `generationCompleted`: [timestamp]
- `outputFiles`: [list of generated files]

### 7. Present MENU OPTIONS

Display: **Proceeding to cache management...**

#### Menu Handling Logic:

- After generation completion, immediately load, read entire file, then execute `{nextStepFile}` to begin caching

#### EXECUTION RULES:

- This is an autonomous step with auto-proceed
- Proceed directly to next step after generation complete

---

## SYSTEM SUCCESS/FAILURE METRICS

### SUCCESS:

- Golden Map JSON complete and valid
- QA Report generated with all sections
- Performance Metrics JSON created
- All outputs validated
- Progress reported verbosely
- Ready to proceed to caching

### SYSTEM FAILURE:

- Incomplete Golden Map structure
- Missing QA Report sections
- Invalid JSON outputs
- Not validating outputs
- Proceeding without all files generated

**Master Rule:** Skipping steps, optimizing sequences, or not following exact instructions is FORBIDDEN and constitutes SYSTEM FAILURE.
